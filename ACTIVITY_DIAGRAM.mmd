---
config:
  theme: base
  themeVariables:
    primaryColor: '#3b82f6'
    primaryTextColor: '#fff'
    primaryBorderColor: '#1e293b'
---
flowchart TD
    Start([ğŸš€ Mulai Aplikasi Math-Room])
    
    Start --> CheckAuth{User Sudah Login?}
    
    CheckAuth -->|Belum| LoginPage[ğŸ“± Tampil Halaman Login]
    CheckAuth -->|Sudah| HomePage[ğŸ  Tampil Halaman Home]
    
    LoginPage --> InputCred[ğŸ‘¤ Input Email & Password]
    InputCred --> ValidateCred{Validasi Kredensial}
    
    ValidateCred -->|Invalid| ShowError1[âŒ Tampil Error Message]
    ShowError1 --> LoginPage
    ValidateCred -->|Valid| SaveSession[ğŸ’¾ Simpan Session ke LocalStorage]
    SaveSession --> HomePage
    
    HomePage --> SelectRole{Pilih Role}
    
    %% ========== ALUR GURU ==========
    SelectRole -->|Guru| TeacherConfig[ğŸ‘¨â€ğŸ« Form Konfigurasi Sesi]
    TeacherConfig --> InputConfig[ğŸ“ Input:<br/>- Topik Materi<br/>- Tingkat Kesulitan<br/>- Max Siswa]
    InputConfig --> GenerateCode[ğŸ² Generate Kode Ruangan<br/>6 digit random]
    GenerateCode --> CreateSession[ğŸ”— Buat Session via Socket.io]
    CreateSession --> TeacherDashboard[ğŸ“Š Masuk Dashboard Guru]
    
    TeacherDashboard --> WaitStudents[â³ Tunggu Siswa Join]
    WaitStudents --> MonitorCanvas[ğŸ‘€ Monitor Canvas Siswa<br/>Real-time via Socket.io]
    
    MonitorCanvas --> TeacherAction{Aksi Guru}
    TeacherAction -->|Monitor Terus| MonitorCanvas
    TeacherAction -->|End Session| ConfirmEnd{Konfirmasi<br/>End Session?}
    
    ConfirmEnd -->|Batal| MonitorCanvas
    ConfirmEnd -->|Ya| BroadcastEnd[ğŸ“¢ Broadcast 'session_ended'<br/>ke semua siswa]
    BroadcastEnd --> DisconnectAll[ğŸ”Œ Disconnect Semua Socket]
    DisconnectAll --> SaveSessionData[ğŸ’¾ Simpan Data Sesi]
    SaveSessionData --> BackHome1[ğŸ  Kembali ke Home]
    
    %% ========== ALUR SISWA ==========
    SelectRole -->|Siswa| StudentInput[ğŸ“ Input Kode Ruangan]
    StudentInput --> ValidateCode{Validasi<br/>Kode Ruangan}
    
    ValidateCode -->|Invalid| ShowError2[âŒ Kode Tidak Valid]
    ShowError2 --> StudentInput
    ValidateCode -->|Valid| CheckCapacity{Ruangan<br/>Penuh?}
    
    CheckCapacity -->|Ya| ShowError3[âŒ Ruangan Sudah Penuh]
    ShowError3 --> StudentInput
    CheckCapacity -->|Tidak| JoinRoom[ğŸ”— Join Room via Socket.io]
    
    JoinRoom --> NotifyTeacher[ğŸ“¢ Notifikasi Guru:<br/> 'Siswa Baru Join']
    NotifyTeacher --> StudentCanvas[ğŸ¨ Tampil Canvas Fullscreen]
    
    StudentCanvas --> DrawingLoop{Aktivitas Siswa}
    
    DrawingLoop -->|Menggambar| SelectTool[ğŸ–Œï¸ Pilih Alat:<br/>- Kuas<br/>- Penghapus<br/>- Color<br/>- Size]
    SelectTool --> DrawOnCanvas[âœï¸ Gambar di Canvas]
    DrawOnCanvas --> EmitDrawing[ğŸ“¡ Emit Drawing Data<br/>via Socket.io]
    EmitDrawing --> UpdateTeacher[ğŸ”„ Update Canvas Guru<br/>Real-time]
    UpdateTeacher --> DrawingLoop
    
    DrawingLoop -->|Undo| UndoAction[â†¶ Hapus Object Terakhir]
    UndoAction --> DrawingLoop
    
    DrawingLoop -->|Clear Canvas| ClearAction[ğŸ—‘ï¸ Hapus Semua Object]
    ClearAction --> DrawingLoop
    
    DrawingLoop -->|Simpan Catatan| OpenModal[ğŸ’¾ Tampil Modal<br/>'Save Note']
    OpenModal --> InputDesc[ğŸ“ Input Deskripsi]
    InputDesc --> ExportImage[ğŸ“· Export Canvas ke Image]
    ExportImage --> SaveToDB[ğŸ’¾ Simpan ke Database<br/>+userEmail +timestamp]
    SaveToDB --> ShowSuccess[âœ… Notifikasi Berhasil]
    ShowSuccess --> DrawingLoop
    
    DrawingLoop -->|Lihat Catatan| OpenSidebar[ğŸ“‚ Buka Sidebar]
    OpenSidebar --> SwitchTab{Tab Sidebar}
    
    SwitchTab -->|Tab Catatan| FetchNotes[ğŸ“¡ Fetch Saved Notes<br/>dari Server]
    FetchNotes --> DisplayNotes[ğŸ“‹ Tampil Galeri Catatan]
    DisplayNotes --> NoteAction{Aksi Catatan}
    
    NoteAction -->|View| ViewNote[ğŸ‘ï¸ Lihat Detail Catatan]
    ViewNote --> DisplayNotes
    NoteAction -->|Delete| ConfirmDelete{Konfirmasi<br/>Hapus?}
    ConfirmDelete -->|Ya| DeleteNote[ğŸ—‘ï¸ Hapus dari Database]
    DeleteNote --> DisplayNotes
    ConfirmDelete -->|Batal| DisplayNotes
    NoteAction -->|Tutup| DrawingLoop
    
    SwitchTab -->|Tab Profil| ShowProfile[ğŸ‘¤ Tampil Data Profil<br/>- Nama<br/>- Email]
    ShowProfile --> ProfileAction{Aksi Profil}
    
    ProfileAction -->|Edit Profil| EditForm[âœï¸ Form Edit Data]
    EditForm --> UpdateProfile[ğŸ’¾ Update Database]
    UpdateProfile --> ShowProfile
    ProfileAction -->|Logout| ConfirmLogout{Konfirmasi<br/>Logout?}
    ProfileAction -->|Tutup| DrawingLoop
    
    ConfirmLogout -->|Batal| ShowProfile
    ConfirmLogout -->|Ya| ClearLocalStorage[ğŸ—‘ï¸ Hapus LocalStorage]
    ClearLocalStorage --> DisconnectSocket[ğŸ”Œ Disconnect Socket]
    DisconnectSocket --> LoginPage
    
    DrawingLoop -->|Leave Room| ConfirmLeave{Konfirmasi<br/>Leave?}
    ConfirmLeave -->|Batal| DrawingLoop
    ConfirmLeave -->|Ya| LeaveRoom[ğŸšª Leave Room Socket]
    LeaveRoom --> NotifyTeacher2[ğŸ“¢ Notif Guru:<br/>'Siswa Keluar']
    NotifyTeacher2 --> BackHome2[ğŸ  Kembali ke Home]
    
    %% ========== SESSION ENDED EVENT ==========
    MonitorCanvas -.->|Receive 'session_ended'| SessionEnded[âš ï¸ Session Dihentikan Guru]
    SessionEnded --> ShowNotif[ğŸ“¢ Tampil Notifikasi<br/>'Session Ended']
    ShowNotif --> AutoLeave[ğŸšª Auto Keluar dari Room]
    AutoLeave --> BackHome2
    
    BackHome1 --> HomePage
    BackHome2 --> HomePage
    
    HomePage --> ViewSavedNotes{Lihat Catatan<br/>Tersimpan?}
    ViewSavedNotes -->|Ya| OpenSidebar
    ViewSavedNotes -->|Tidak| SelectRole
    
    %% ========== STYLING ==========
    style Start fill:#10b981,stroke:#1e293b,color:#fff,stroke-width:3px
    style LoginPage fill:#3b82f6,stroke:#1e293b,color:#fff
    style HomePage fill:#8b5cf6,stroke:#1e293b,color:#fff
    style TeacherDashboard fill:#8b5cf6,stroke:#1e293b,color:#fff
    style StudentCanvas fill:#3b82f6,stroke:#1e293b,color:#fff
    
    style CheckAuth fill:#f59e0b,stroke:#1e293b,color:#fff
    style ValidateCred fill:#f59e0b,stroke:#1e293b,color:#fff
    style SelectRole fill:#f59e0b,stroke:#1e293b,color:#fff
    style ValidateCode fill:#f59e0b,stroke:#1e293b,color:#fff
    style CheckCapacity fill:#f59e0b,stroke:#1e293b,color:#fff
    style TeacherAction fill:#f59e0b,stroke:#1e293b,color:#fff
    style DrawingLoop fill:#f59e0b,stroke:#1e293b,color:#fff
    style SwitchTab fill:#f59e0b,stroke:#1e293b,color:#fff
    style NoteAction fill:#f59e0b,stroke:#1e293b,color:#fff
    style ProfileAction fill:#f59e0b,stroke:#1e293b,color:#fff
    style ConfirmEnd fill:#f59e0b,stroke:#1e293b,color:#fff
    style ConfirmDelete fill:#f59e0b,stroke:#1e293b,color:#fff
    style ConfirmLogout fill:#f59e0b,stroke:#1e293b,color:#fff
    style ConfirmLeave fill:#f59e0b,stroke:#1e293b,color:#fff
    style ViewSavedNotes fill:#f59e0b,stroke:#1e293b,color:#fff
    
    style ShowError1 fill:#ef4444,stroke:#1e293b,color:#fff
    style ShowError2 fill:#ef4444,stroke:#1e293b,color:#fff
    style ShowError3 fill:#ef4444,stroke:#1e293b,color:#fff
    style SessionEnded fill:#ef4444,stroke:#1e293b,color:#fff
    
    style SaveSession fill:#10b981,stroke:#1e293b,color:#fff
    style GenerateCode fill:#10b981,stroke:#1e293b,color:#fff
    style CreateSession fill:#10b981,stroke:#1e293b,color:#fff
    style JoinRoom fill:#10b981,stroke:#1e293b,color:#fff
    style EmitDrawing fill:#10b981,stroke:#1e293b,color:#fff
    style UpdateTeacher fill:#10b981,stroke:#1e293b,color:#fff
    style SaveToDB fill:#10b981,stroke:#1e293b,color:#fff
    style ShowSuccess fill:#10b981,stroke:#1e293b,color:#fff
    style NotifyTeacher fill:#10b981,stroke:#1e293b,color:#fff
    style NotifyTeacher2 fill:#10b981,stroke:#1e293b,color:#fff
    style BroadcastEnd fill:#10b981,stroke:#1e293b,color:#fff
